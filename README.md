## Κ24: Προγραμματισμός Συστήματος - 2η Εργασία

### Ονοματεπώνυμο: Λεωνίδας Κουτσούκης

### Περιγραφή

Στην παρούσα εργασία, ο **client** στέλνει εντολές, όπως π.χ. `issueJob wget...`, στον **server** μέσω TCP sockets. Ο server ακούει σε μια συγκεκριμένη θύρα, π.χ. 55555, και δέχεται συνδέσεις από τους clients.

Όταν ένας client συνδέεται, ο server εκτελεί `accept`, δημιουργώντας ένα νέο socket για τον συγκεκριμένο client. Αυτό το socket χρησιμεύει ως κανάλι επικοινωνίας, επιτρέποντας την ανταλλαγή μηνυμάτων μεταξύ client και server. Το κανάλι αυτό είναι αμφίδρομο, επιτρέποντας αλληλεπιδραστική επικοινωνία και από τις δύο πλευρές.

Ο server είναι σχεδιασμένος να δέχεται πολλαπλούς clients. Κάθε νέος client δημιουργεί το δικό του socket και συνδέεται στον server, ο οποίος εκτελεί `accept` για κάθε σύνδεση, δημιουργώντας νέα κανάλια επικοινωνίας.

Η επικοινωνία πραγματοποιείται μέσω των `read` και `write`. Ο client στέλνει δεδομένα μέσω `write` και λαμβάνει δεδομένα μέσω `read`.

Στη συνέχεια, ο server, αφού λάβει μια εντολή από τον client, την αναθέτει σε ένα controller thread. Το controller thread αναλαμβάνει την επικοινωνία με τον συγκεκριμένο client. Δηλαδή, το controller thread διαχειρίζεται τη συνομιλία και την εκτέλεση εντολών από τον client.

Αν η εντολή είναι διαφορετική από `issueJob` (π.χ. `poll`, `exit`, `stop`, `setConcurrency`), το controller thread εκτελεί την εντολή και επιστρέφει την απάντηση στον client μέσω του socket.

Αν η εντολή είναι `issueJob`, το job τοποθετείται σε μια ουρά (producer-consumer queue). Η ουρά αυτή έχει συγκεκριμένη χωρητικότητα (`bufferSize`), και σε αυτήν τοποθετούνται όλα τα jobs που προορίζονται για εκτέλεση.

Τα controller threads έχουν ως κύρια ευθύνη την επικοινωνία με τους clients. Η εκτέλεση των jobs ανατίθεται στα worker threads, τα οποία έχουν σταθερό αριθμό και δεν εξαρτώνται από τον αριθμό των clients.

Τα worker threads παίρνουν τα jobs από την ουρά και τα εκτελούν. Επειδή τα threads δεν μπορούν να εκτελέσουν διεργασίες απευθείας, χρησιμοποιούν την εντολή `fork` για να δημιουργήσουν διεργασίες, οι οποίες εκτελούν τα jobs μέσω της εντολής `exec`. Τα αποτελέσματα αποθηκεύονται σε αρχεία στο δίσκο.

Μετά την ολοκλήρωση της διεργασίας, το thread καλεί την `wait()` για να περιμένει τον τερματισμό της διεργασίας. Όταν η διεργασία τερματίσει, το thread διαβάζει την απάντηση από το αρχείο και την αποστέλλει στον client.


### Παραδοχές

#### Διαγραφή 

Οι εντολές στην ουρά δεν αφαιρούνται αμέσως αλλά σημειώνονται προς διαγραφή. Οι workers όταν παίρνουν ένα job ελέγχουν αν είναι σημειωμένο και αν ναι, το αγνοούν.

Με αυτόν τον τρόπο, η διαχείριση των jobs γίνεται αποκλειστικά από τα worker threads.


#### Δομή εργασίας

Η δομή για ένα Job έχει τη μορφή:
```C++
typedef struct Job {
    char job_id[100];
    char command[4096];
    pid_t pid;
    int socket;    
} Job;
```

Τα job_id δεν μπορούν να ξεπερνάνε τα 100 σύμβολα (είναι τεράστιος ακέραιος αριθμός για να υπάρχει ρεαλιστικά περιορισμός).

Τα commands δεν μπορούν να ξεπερνάνε τα 4ΚΒ. Αυτό είναι λογικό καθώς το κέλυφος ούτως ή άλλως έχει περιορισμό μήκους.

#### Τερματισμός server

Για τον τερματισμό παράγουμε ειδικά jobs με περιεχόμενο "-". Οι workers όταν λάβουν ένα τέτοιο job τερματίζουν.



## Περιγραφή Δομής Καταλόγων

Η εργασία πρέπει να ακολουθεί την παρακάτω ιεραρχία καταλόγων:



### Αναλυτική Περιγραφή των Καταλόγων

- **bin/**: Περιέχει τα εκτελέσιμα αρχεία που δημιουργούνται μετά τη μεταγλώττιση των πηγαίων αρχείων. Σε αυτόν τον κατάλογο θα βρίσκονται τα εκτελέσιμα προγράμματα `jobCommander` και `jobExecutorServer`.

- **build/**: Περιέχει προσωρινά αρχεία που δημιουργούνται κατά τη διαδικασία μεταγλώττισης. Ο κατάλογος αυτός δεν περιλαμβάνει μόνιμα αρχεία και μπορεί να διαγραφεί και να αναδημιουργηθεί κατά τη μεταγλώττιση.

- **include/**: Περιέχει τα αρχεία κεφαλίδων (*.h) που χρησιμοποιούνται από τα πηγαία αρχεία του προγράμματος.

- **lib/**: Περιέχει τις εξωτερικές βιβλιοθήκες που χρησιμοποιούνται από το πρόγραμμα.

- **src/**: Περιέχει τα πηγαία αρχεία (*.c) του προγράμματος. Εδώ βρίσκονται οι κύριοι ορισμοί και υλοποιήσεις των συναρτήσεων.

- **tests/**: Περιέχει τα πηγαία αρχεία για τα τεστ (*.c) που χρησιμοποιούνται για τη δοκιμή του προγράμματος.

- **Makefile**: Το αρχείο Makefile περιέχει τους κανόνες για τη μεταγλώττιση του προγράμματος και τη δημιουργία των εκτελέσιμων αρχείων.

- **README.md**: Το παρόν αρχείο, που περιέχει οδηγίες για την οργάνωση, τη μεταγλώττιση και την εκτέλεση του προγράμματος.


### Μεταγλώτισση

```sh
make
```

### Εκτέλεση 1

Για executor:

```sh
./bin/jobExecutor 55555 100 4
```

- 55555: η θύρα
- 100: το μέγεθος ουράς
- 4: πλήθος νημάτων

Με makefile για executor:

```sh
make run2
```

Για commander:

```sh
./bin/jobCommander 127.0.0.1 55555 issueJob wget https://www.tovima.gr/2024/06/13/finance/aplisiasto-to-pagoto-eos-kai-4-eyro-kostizei-i-mia-mpala
```

- 127.0.0.1: ΙΡ ή hostname του server
- 55555: η θύρα
- issueJob: η εντολή μαζί με τις παραμέτρους της (όπως δίνονται στην εκφώνηση)

Με makefile για commander:

```sh
make run1
```


### Εκτέλεση 2 στα μηχανηματα linux της σχολης(εξ αποστάσεως)

Για executor:

- Σύνδεση στο μηχάνημα linux20 
```sh
ssh sdixxxxxxx@linux20.di.uoa.gr
```
- sdixxxxxxx: Το username, όπου το xxxxxxx είναι οι αριθμοί από τον αριθμό μητρώου(ΑΜ) ή ένα μοναδικό αναγνωριστικό.

```sh
./bin/jobExecutor 55555 100 4
```

- 55555: η θύρα
- 100: το μέγεθος ουράς
- 4: πλήθος νημάτων

Με makefile για executor:

```sh
make run2
```

Για commander: 

- Σύνδεση στο μηχάνημα linux14

```sh
ssh sdixxxxxxx@linux14.di.uoa.gr
```

```sh
./bin/jobCommander xxx.xxx.xx.xx 55555 issueJob ls 
```

- xxx.xxx.xx.xx: ΙΡ ή hostname του server(linux20)
- 55555: η θύρα
- issueJob: η εντολή μαζί με τις παραμέτρους της (όπως δίνονται στην εκφώνηση)


```sh
./bin/jobCommander xxx.xxx.xx.xx 55555 exit
```

 
